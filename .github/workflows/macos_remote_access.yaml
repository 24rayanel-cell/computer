name: Windows - CRD y Tailscale (Acceso por Google)

on:
  workflow_dispatch:

jobs:
  remote_session_crd_ts:
    name: Iniciar Sesi√≥n Remota (M√°x 9999 minutos)
    runs-on: windows-latest
    timeout-minutes: 9999
    
    steps:
      
      - name: üöÄ 1. Instalaci√≥n y Autenticaci√≥n de Tailscale (REFORZADO Y DIN√ÅMICO)
        env:
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          Write-Host "--- 1. Tailscale Setup ---"
          
          # URL del MSI estable para Windows
          $InstallerURL = "https://pkgs.tailscale.com/stable/tailscale-setup-latest.msi"
          $InstallerPath = "C:\Users\runneradmin\tailscale-setup.msi"
          
          Write-Host "Descargando Tailscale MSI con .NET WebClient (M√©todo Definitivo)..."
          # üí° FIX: Usamos System.Net.WebClient para evitar fallos de Invoke-WebRequest
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          $webclient = New-Object System.Net.WebClient
          $webclient.DownloadFile($InstallerURL, $InstallerPath)
          
          # Instalaci√≥n silenciosa del MSI
          Write-Host "Instalando Tailscale silenciosamente..."
          Start-Process msiexec -ArgumentList "/i $InstallerPath /qn" -Wait
          
          # üö® B√∫squeda din√°mica de la ruta de tailscale.exe
          $TailscalePath = Get-ChildItem -Path "C:\Program Files*" -Recurse -Include "tailscale.exe" | Select-Object -ExpandProperty FullName -First 1
          
          if (-not $TailscalePath) {
              Write-Host "::error::ERROR: No se encontr√≥ tailscale.exe despu√©s de la instalaci√≥n. Fallo en la instalaci√≥n del MSI."
              exit 1
          }
          Write-Host "Ruta de Tailscale encontrada: $TailscalePath"
          
          # Autenticaci√≥n de Tailscale usando la ruta encontrada
          & $TailscalePath install-service
          & $TailscalePath up --authkey=$env:TAILSCALE_AUTHKEY --hostname="github-runner-crd" --accept-dns=false
          
          Write-Host "‚úÖ Tailscale instalado y autenticado."
          
      - name: üåê 2. Descargar e Instalar Chrome Remote Desktop Host
        run: |
          Write-Host "--- 2. Instalando CRD Host ---"
          $InstallerURL = "https://dl.google.com/dl/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi"
          $OutputPath = "C:\Users\runneradmin\chromeremotedesktophost.msi"
          
          Write-Host "Descargando CRD Host con .NET WebClient..."
          # üí° FIX: Usamos System.Net.WebClient para la descarga del MSI de CRD
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          $webclient = New-Object System.Net.WebClient
          $webclient.DownloadFile($InstallerURL, $OutputPath)
          
          # Instalaci√≥n silenciosa del MSI
          Write-Host "Instalando Host de CRD..."
          Start-Process msiexec -ArgumentList "/i $OutputPath /qn" -Wait
          Write-Host "Instalaci√≥n de CRD Host completada."

      - name: üîë 3. Configurar y Ejecutar Servicio de CRD (C√ìDIGO √öNICO)
        env:
          # üö® ¬°REEMPLAZA ESTE C√ìDIGO CON UNO NUEVO Y RECI√âN GENERADO!
          CRD_AUTH_CODE: "4/0Ab32j91SMKCxGVyOT2gHvDoL7nXDuhVm-fj0eTuJXVyei7Z2-DmlNU8kxgfiZQJGjkpkqw" 
          CRD_REDIRECT_URL: "https://remotedesktop.google.com/_/oauthredirect"
          CRD_HOST_NAME: "GitHub-Runner-CRD-TS"
          CRD_PIN: "123456" # PIN para acceder
          
        run: |
          Write-Host "--- 3. Configurando CRD con c√≥digo OAuth ---"

          # B√∫squeda din√°mica de la ruta de remoting_host.exe
          $CRD_HOST_PATH = Get-ChildItem -Path "C:\Program Files*" -Recurse -Include "remoting_host.exe" | Select-Object -ExpandProperty FullName -First 1
          $CRD_CLI_PATH = Get-ChildItem -Path "C:\Program Files*" -Recurse -Include "host_service_cli.exe" | Select-Object -ExpandProperty FullName -First 1

          if (-not $CRD_HOST_PATH -or -not $CRD_CLI_PATH) {
              Write-Host "::error::ERROR: No se encontr√≥ uno o ambos ejecutables de CRD despu√©s de la instalaci√≥n."
              exit 1
          }
          Write-Host "Ruta de CRD Host encontrada: $CRD_HOST_PATH"

          # 1. Configurar el Host con el c√≥digo de autenticaci√≥n
          & $CRD_HOST_PATH --code="$env:CRD_AUTH_CODE" `
              --redirect-url="$env:CRD_REDIRECT_URL" `
              --host-name="$env:CRD_HOST_NAME" `
              --pin="$env:CRD_PIN" `
              --host-client-id="40693247926.apps.googleusercontent.com" `
              --host-secret="V0RjYjVwTEdmYlQzY3pBcU40b2Y5Q1g=" `
              --no-start

          # 2. Iniciar el servicio (usa la CLI para asegurar el inicio)
          Write-Host "Iniciando el servicio..."
          Start-Process -FilePath $CRD_CLI_PATH -ArgumentList "start" -Wait
          
          Write-Host "‚úÖ CRD Host configurado. Con√©ctate v√≠a web de Google. Tailscale est√° activo."

      - name: ‚è≥ 4. Mantener el Runner Vivo
        run: |
          Write-Host "--- 4. Manteniendo la Sesi√≥n Abierta (M√°x 9999 minutos) ---"
          Start-Sleep -Seconds 9999999
