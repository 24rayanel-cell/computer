name: macOS - Tailscale & RustDesk Remote Access (VNC Funcional - FINAL)

on:
  workflow_dispatch:

jobs:
  remote_session:
    name: Iniciar Sesi√≥n Remota (M√°x 6 Horas)
    runs-on: macos-latest
    timeout-minutes: 360

    steps:
      # 1. Instalar Tailscale
      - name: üöÄ Instalar y Autenticar Tailscale
        env:
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          echo "--- 1. Instalar y Autenticar Tailscale ---"
          brew install tailscale
          
          echo "--- 1.1. Iniciando el servicio Tailscale (daemon) ---"
          sudo tailscaled &
          sleep 5

          if [ -z "$TAILSCALE_AUTHKEY" ]; then
            echo "::error::ERROR: La clave TAILSCALE_AUTHKEY est√° vac√≠a o no configurada."
            exit 1 
          else
            echo "--- 1.2. Autenticando Tailscale ---"
            HOSTNAME="github-mac-runner-$(uuidgen | head -c 8)"
            sudo tailscale up --authkey=$TAILSCALE_AUTHKEY --hostname=$HOSTNAME --accept-dns=false
            
            TS_IP=$(tailscale status | grep $HOSTNAME | grep -v 'offline' | awk '{print $1}')
            
            echo "‚úÖ Tailscale est√° corriendo. IP Address:"
            tailscale status
            
            echo "TS_IP=$TS_IP" >> $GITHUB_ENV
            echo "--- IP del Runner Activo: $TS_IP ---"
          fi

      # 2. Instalar TigerVNC y RustDesk
      - name: üì¶ Instalar Herramientas Remotas (VNC y RustDesk)
        run: |
          echo "--- 2. Instalando TigerVNC y RustDesk ---"
          # Forzamos la instalaci√≥n y que el binario se establezca
          brew install tiger-vnc
          brew install --cask rustdesk
          echo "RustDesk instalado en /Applications/RustDesk.app"
          
          # SOLUCI√ìN DE FALLO: Hacemos un link expl√≠cito si no existe (a veces necesario en CI)
          ln -s /opt/homebrew/Cellar/tiger-vnc/*/bin/vncpasswd /opt/homebrew/bin/vncpasswd || true
          ln -s /opt/homebrew/Cellar/tiger-vnc/*/bin/vncserver /opt/homebrew/bin/vncserver || true


      # 3. Configurar y Ejecutar VNC (¬°Ahora con los binarios asegurados!)
      - name: üñ•Ô∏è Configurar y Habilitar Servidor VNC
        run: |
          echo "--- 3. Configurando Contrase√±a y Daemon VNC ---"
          
          echo "--- 3.1. Estableciendo Contrase√±a VNC ---"
          # Usamos la ruta absoluta que Homebrew deber√≠a haber configurado
          VNC_BIN_PATH="/opt/homebrew/bin"

          mkdir -p ~/.vnc
          # Usamos la ruta absoluta asegurada
          echo "password" | $VNC_BIN_PATH/vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          
          echo "--- 3.2. Iniciando Servidor VNC ---"
          $VNC_BIN_PATH/vncserver :1 -geometry 1280x1024 -depth 24
          
          echo "==========================================================="
          echo "‚úÖ CONEXI√ìN GR√ÅFICA LISTA (TigerVNC)"
          echo "Direcci√≥n VNC: ${{ env.TS_IP }}:5901"
          echo "Contrase√±a VNC: password"
          echo "==========================================================="

      # 4. Mantener el flujo de trabajo activo
      - name: ‚è≥ Mantener el Runner Vivo para Acceso Remoto
        run: |
          echo "--- 4. Manteniendo la Sesi√≥n Abierta (M√°x 360 minutos) ---"
          sleep 21600
