name: macOS - Tailscale & VNC (Soluci√≥n Garantizada)

on:
  workflow_dispatch:

jobs:
  remote_session:
    name: Iniciar Sesi√≥n Remota (M√°x 6 Horas)
    runs-on: macos-latest
    timeout-minutes: 360

    steps:
      # 1. Instalar Tailscale
      - name: üöÄ Instalar y Autenticar Tailscale
        env:
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          echo "--- 1. Instalar y Autenticar Tailscale ---"
          brew install tailscale
          
          echo "--- 1.1. Iniciando el servicio Tailscale (daemon) ---"
          sudo tailscaled &
          sleep 5

          if [ -z "$TAILSCALE_AUTHKEY" ]; then then
            echo "::error::ERROR: La clave TAILSCALE_AUTHKEY est√° vac√≠a o no configurada."
            exit 1 
          else
            echo "--- 1.2. Autenticando Tailscale ---"
            HOSTNAME="github-mac-runner-$(uuidgen | head -c 8)"
            sudo tailscale up --authkey=$TAILSCALE_AUTHKEY --hostname=$HOSTNAME --accept-dns=false
            
            TS_IP=$(tailscale status | grep $HOSTNAME | grep -v 'offline' | awk '{print $1}')
            
            echo "‚úÖ Tailscale est√° corriendo. IP Address:"
            tailscale status
            
            echo "TS_IP=$TS_IP" >> $GITHUB_ENV
            echo "--- IP del Runner Activo: $TS_IP ---"
          fi

      # 2. Configurar el Entorno Gr√°fico (XQuartz + VNC)
      - name: üñ•Ô∏è Configurar Entorno Gr√°fico (X11/VNC Nativo)
        run: |
          echo "--- 2. Instalando XQuartz y gestor de ventanas (Fluxbox) ---"
          # Instalamos XQuartz (X11) y Fluxbox (gestor de ventanas ligero)
          brew install --cask xquartz
          brew install fluxbox
          
          echo "--- 2.1. Habilitando Escritorio Remoto Nativo (VNC) ---"
          # Habilitamos la compartici√≥n de pantalla con una contrase√±a simple
          # NOTA: La contrase√±a DEBE tener exactamente 8 caracteres para el VNC nativo de Apple.
          sudo defaults write /var/db/launchd.db/com.apple.launchd/overrides.plist com.apple.screensharing -dict Disabled -bool false
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist
          
          # Establecemos una contrase√±a de VNC (8 caracteres)
          VNC_PASSWORD="password"
          
          # Creamos la carpeta de VNC si no existe
          mkdir -p ~/.vnc

          # Establecemos la contrase√±a en el sistema (requiere privilegios)
          # Esto es complejo en CI/CD, usaremos la configuraci√≥n de VNC m√°s b√°sica.
          # Usamos un script para configurar el VNC server en el puerto 5900
          export DISPLAY=:0
          
          # Iniciamos el VNC server de forma sencilla
          /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -activate -configure -accesson -users runner -privs -all -clientopts -setvnclegacy -vnclegacy yes -setvncpw $VNC_PASSWORD -vncpw $VNC_PASSWORD

          echo "==========================================================="
          echo "‚úÖ CONEXI√ìN GR√ÅFICA LISTA (VNC Nativo/Kickstart)"
          echo "Direcci√≥n
