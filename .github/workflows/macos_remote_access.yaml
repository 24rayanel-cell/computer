name: CRD-Ubuntu

on:
  workflow_dispatch:

jobs:
  crd-ubuntu:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      # --- Paso 1: Instalar CRD Host y XFCE4 ---
      - name: 1. Instalar CRD Host y XFCE4 Desktop
        run: |
          echo "üîê Instalando Chrome Remote Desktop y entorno de escritorio..."
          
          # Actualizar e instalar dependencias b√°sicas
          sudo apt-get update -y
          sudo apt-get install -y wget curl x11-utils x11-xserver-utils
          
          # Descargar e instalar el paquete .deb de CRD
          CRD_DEB="chrome-remote-desktop_current_amd64.deb"
          wget -q -O $CRD_DEB https://dl.google.com/linux/direct/chrome-remote-desktop_current_amd64.deb
          sudo dpkg -i $CRD_DEB || sudo apt-get install -f -y 
          rm $CRD_DEB
          
          # Instalar XFCE4 y configurar CRD para usarlo
          echo "üñ•Ô∏è Instalando entorno de escritorio XFCE4..."
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y xfce4 xfce4-terminal xubuntu-core
          echo "exec /usr/sbin/startxfce4" | sudo tee /etc/chrome-remote-desktop-session
          
      # --- Paso 2: Configurar Tailscale ---
      - name: 2. Configurar e Iniciar Tailscale
        run: |
          echo "üîë Configurando Tailscale..."
          curl -fsSL https://tailscale.com/install.sh | sudo sh
          
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-crd-$GITHUB_RUN_ID --accept-routes
          
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          
      # --- Paso 3: Registrar Chrome Remote Desktop Host (¬°CAMBIO CR√çTICO!) ---
      - name: 3. Registrar Chrome Remote Desktop Host y Arrancar el Servicio
        run: |
          echo "üîë Registrando Chrome Remote Desktop host..."
          
          AUTH_CODE="4/0Ab32j91rcqKZ7F64JQMgJCztxzvNGD6SKfglqNGH8Blnl4wETeb1z2TptoVaZSDLTNLU1A"
          PIN="12345678"
          
          # Paso 3a: Registro de la m√°quina con el c√≥digo y el PIN
          # El comando de registro crea el archivo de configuraci√≥n para el usuario actual.
          DISPLAY= /opt/google/chrome-remote-desktop/start-host \
            --code="$AUTH_CODE" \
            --redirect-url="https://remotedesktop.google.com/_/oauthredirect" \
            --name="gh-crd-$(hostname)" \
            --pin="$PIN"
            
          # Paso 3b: Configurar y habilitar el servicio CRD (systemd)
          # Esto asegura que el servicio se ejecute en segundo plano de forma estable.
          echo "üîß Habilitando el servicio CRD en segundo plano..."
          # Obtener el nombre de usuario del runner (usualmente 'runner' o 'github')
          RUNNER_USER=$(whoami)
          
          # Habilitar 'linger' para que los servicios de usuario se mantengan activos sin sesi√≥n
          sudo loginctl enable-linger $RUNNER_USER
          
          # Arrancar el servicio de Chrome Remote Desktop para el usuario actual
          # Usamos 'systemctl --user' para el servicio de usuario de CRD
          sudo systemctl start chrome-remote-desktop@$RUNNER_USER.service
          
          # Verificar estado (opcional, para depuraci√≥n)
          # systemctl --user status chrome-remote-desktop@$RUNNER_USER.service

            
      # --- Paso 4: Mantener el CRD activo ---
      - name: 4. Monitorear y Mantener CRD Online
        run: |
          echo -e "\n=== Chrome Remote Desktop Activo === "
          echo "Tailscale IP: ${{ env.TAILSCALE_IP }}"
          echo "Con√©ctate a trav√©s de Chrome Remote Desktop web usando el PIN 12345678"
          echo "==============================\n"
          
          # El job principal debe seguir ejecut√°ndose para evitar que el runner se cierre.
          # Ya que el servicio CRD est√° corriendo con systemd, el job solo necesita esperar el timeout.
          while true; do
            echo "[$(date)] CRD activo (gestionado por systemd), esperando timeout..."
            sleep 300 # Espera 5 minutos
          done
