name: macOS - Tailscale & RustDesk Remote Access

on:
  # Permite ejecutar este flujo de trabajo manualmente desde la pesta√±a 'Actions'
  workflow_dispatch:

jobs:
  remote_session:
    name: Iniciar Sesi√≥n Remota (M√°x 6 Horas)
    runs-on: macos-latest
    # Tiempo m√°ximo de ejecuci√≥n permitido por GitHub (360 minutos = 6 horas)
    timeout-minutes: 360

    steps:
      # 1. Configurar e Instalar Tailscale
      - name: üöÄ Instalar y Configurar Tailscale
        env:
          # Se usa el secreto que ya has configurado (TAILSCALE_AUTHKEY)
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          echo "--- 1. Instalando Tailscale ---"
          # Instalar Tailscale usando Homebrew
          brew install tailscale
          
          echo "--- 1.1. Iniciando el servicio Tailscale (daemon) ---"
          # CORRECCI√ìN CLAVE: Iniciar el daemon en segundo plano para que 'tailscale up' funcione
          sudo tailscaled &
          # Damos un momento al daemon para inicializarse
          sleep 5

          if [ -z "$TAILSCALE_AUTHKEY" ]; then
            echo "::error::ERROR: La clave TAILSCALE_AUTHKEY est√° vac√≠a o no configurada. Por favor, revisa tus secretos."
            exit 1 
          else
            echo "--- 1.2. Autenticando Tailscale ---"
            # Autenticar Tailscale usando la clave
            sudo tailscale up --authkey=$TAILSCALE_AUTHKEY --hostname=github-mac-runner --accept-dns=false
            echo "‚úÖ Tailscale est√° corriendo. IP Address:"
            tailscale status
          fi

      # 2. Instalar RustDesk
      - name: üñ•Ô∏è Instalar RustDesk (Cask)
        run: |
          echo "--- 2. Instalando RustDesk v√≠a Homebrew Cask ---"
          # RustDesk se instala como una aplicaci√≥n GUI (Cask)
          brew install --cask rustdesk
          echo "RustDesk instalado en /Applications/RustDesk.app"

      # 3. Mantener el flujo de trabajo activo
      - name: ‚è≥ Mantener el Runner Vivo para Acceso Remoto
        run: |
          echo "--- 3. Manteniendo la Sesi√≥n Abierta (M√°x 360 minutos) ---"
          # Este comando detiene la ejecuci√≥n del flujo de trabajo por 6 horas (21600 segundos).
          # El job terminar√° autom√°ticamente cuando se agote el tiempo de timeout.
          sleep 21600
