name: SSH Access Only via Tailscale

on:
  # Permite ejecutar el flujo de trabajo manualmente
  workflow_dispatch:

jobs:
  ssh-access:
    # Usamos el runner de Ubuntu
    runs-on: ubuntu-latest
    # Mantenemos el timeout para que tengas tiempo para conectarte
    timeout-minutes: 3600

    steps:
      # --- Paso 1: Configurar Tailscale e instalar el servicio SSH (OpenSSH) ---
      - name: 1. Instalar Tailscale y OpenSSH
        run: |
          echo " Configurando Tailscale y asegurando SSH..."
          
          # Actualizar e instalar OpenSSH (necesario para la terminal remota)
          sudo apt-get update -y
          sudo apt-get install -y openssh-server curl
          
          # Instalar Tailscale con el m茅todo robusto de script
          curl -fsSL https://tailscale.com/install.sh | sudo sh
          
      # --- Paso 2: Iniciar Tailscale y habilitar SSH ---
      - name: 2. Iniciar Tailscale y Habilitar SSH
        run: |
          echo " Iniciando Tailscale..."
          
          # Iniciar Tailscale usando el secreto de autenticaci贸n
          # Habilitamos la funci贸n 'ssh' de Tailscale para un acceso sin contrase帽a
          sudo tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=gh-ssh-$(uuidgen | head -c 8) \
            --accept-routes \
            --ssh
          
          # Obtener la IP de Tailscale y guardarla en una variable de entorno de GitHub
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          
      # --- Paso 3: Mantener el Job Online ---
      - name: 3. Mantener Conexi贸n Activa
        run: |
          echo -e "\n=== Terminal SSH Activa via Tailscale ==="
          echo "1. Aseg煤rate de tener Tailscale instalado en tu m谩quina local."
          echo "2. Con茅ctate a la terminal SSH (el nombre de usuario es el del runner, probablemente 'runner'):"
          echo -e "\n   ssh runner@$TS_IP"
          echo -e "\n   O usando el hostname (reemplaza 'gh-ssh-...' con el nombre completo de tu dispositivo en Tailscale):"
          echo "   ssh runner@$(tailscale status --json | jq -r '.Self.HostName')"
          echo "========================================================\n"
          
          # Mantener el job activo hasta que se agote el timeout
          while true; do
            echo "[$(date)] Conexi贸n SSH activa. Esperando timeout..."
            sleep 300 # Espera 5 minutos
          done
