name: macOS - Tailscale & SSH (Acceso Fijo - Contrase√±a Forzada)

on:
  workflow_dispatch:

jobs:
  remote_session:
    name: Iniciar Sesi√≥n Remota (M√°x 6 Horas)
    runs-on: macos-latest
    timeout-minutes: 360

    steps:
      # 1. Instalar y Autenticar Tailscale
      - name: üöÄ Instalar y Autenticar Tailscale
        env:
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          echo "--- 1. Tailscale Setup ---"
          brew install tailscale
          sudo tailscaled &
          sleep 5

          if [ -z "$TAILSCALE_AUTHKEY" ]; then
            echo "::error::ERROR: La clave TAILSCALE_AUTHKEY est√° vac√≠a o no configurada."
            exit 1 
          else
            HOSTNAME="github-mac-runner-$(uuidgen | head -c 8)"
            sudo tailscale up --authkey=$TAILSCALE_AUTHKEY --hostname=$HOSTNAME --accept-dns=false
            TS_IP=$(tailscale status | grep $HOSTNAME | grep -v 'offline' | awk '{print $1}')
            echo "TS_IP=$TS_IP" >> $GITHUB_ENV
            echo "--- IP del Runner Activo: $TS_IP ---"
          fi

      # 2. Configurar el Entorno Gr√°fico y Contrase√±a SSH
      - name: üñ•Ô∏è Configurar Entorno Gr√°fico y Forzar Contrase√±a SSH
        run: |
          echo "--- 2. Instalando Dependencias Gr√°ficas ---"
          # Instalar 'expect' para forzar la contrase√±a
          brew install expect
          brew install --cask xquartz
          brew install flux
          
          SSH_PASSWORD="runnerpass"
          RUNNER_USER="runner"
          KICKSTART_PATH="/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart"

          # 2.2. A. Asegurar que el shell del usuario 'runner' sea v√°lido
          echo "--- 2.2. A. Asegurar shell Bash para 'runner' ---"
          sudo dscl . -change /Users/$RUNNER_USER UserShell /bin/false /bin/bash

          # 2.2. B. Forzar la nueva contrase√±a usando 'expect'
          echo "--- 2.2. B. Forzar Contrase√±a SSH a: $SSH_PASSWORD ---"
          # Usamos un script 'expect' para simular la entrada del comando 'passwd' y forzar el cambio.
          /usr/bin/expect <<EOD
            set timeout 10
            spawn sudo passwd $RUNNER_USER
            expect "Changing password for $RUNNER_USER."
            expect "New password:"
            send "$SSH_PASSWORD\r"
            expect "Retype new password:"
            send "$SSH_PASSWORD\r"
            expect eof
          EOD

          # 2.3. Habilitar SSH y VNC (como respaldo)
          echo "--- 2.3. Habilitar SSH y VNC ---"
          sudo systemsetup -setremotelogin on
          sudo defaults write /var/db/launchd.db/com.apple.launchd/overrides.plist com.apple.screensharing -dict Disabled -bool false
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist
          sudo $KICKSTART_PATH -activate -configure -access -on -privs -all -restart -agent

          echo "==========================================================="
          echo "‚úÖ SSH LISTO PARA LOGIN"
          echo "Direcci√≥n SSH/Tailscale: ${{ env.TS_IP }}"
          echo "Usuario: $RUNNER_USER"
          echo "Contrase√±a SSH: $SSH_PASSWORD"
          echo "==========================================================="

      # 3. Mantener el flujo de trabajo activo
      - name: ‚è≥ Mantener el Runner Vivo para Acceso Remoto
        run: |
          echo "--- 3. Manteniendo la Sesi√≥n Abierta (M√°x 360 minutos) ---"
          sleep 21600
