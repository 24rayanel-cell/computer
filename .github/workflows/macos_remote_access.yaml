name: macOS - Tailscale & RustDesk Remote Access (TigerVNC Enabled)

on:
  workflow_dispatch:

jobs:
  remote_session:
    name: Iniciar Sesi√≥n Remota (M√°x 6 Horas)
    runs-on: macos-latest
    timeout-minutes: 360

    steps:
      # 1. Configurar e Instalar Tailscale
      - name: üöÄ Instalar y Configurar Tailscale
        env:
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          echo "--- 1. Instalando Tailscale ---"
          brew install tailscale
          
          echo "--- 1.1. Iniciando el servicio Tailscale (daemon) ---"
          # Iniciar el daemon en segundo plano
          sudo tailscaled &
          sleep 5

          if [ -z "$TAILSCALE_AUTHKEY" ]; then
            echo "::error::ERROR: La clave TAILSCALE_AUTHKEY est√° vac√≠a o no configurada."
            exit 1 
          else
            echo "--- 1.2. Autenticando Tailscale ---"
            # Capturamos la IP de Tailscale para mostrarla m√°s tarde
            sudo tailscale up --authkey=$TAILSCALE_AUTHKEY --hostname=github-mac-runner --accept-dns=false
            TS_IP=$(tailscale status | grep github-mac-runner | awk '{print $1}')
            echo "TS_IP=$TS_IP" >> $GITHUB_ENV
            echo "‚úÖ Tailscale est√° corriendo. IP Address:"
            tailscale status
          fi

      # 2. Habilitar el Escritorio Remoto (VNC)
      - name: üñ•Ô∏è Instalar y Habilitar VNC Server (TigerVNC)
        run: |
          echo "--- 2. Instalando un servidor VNC para acceso gr√°fico ---"
          # CORRECCI√ìN: Usamos 'tiger-vnc' en lugar de 'tightvnc'
          brew install tiger-vnc

          # Inicializar el servidor VNC. El primer inicio puede pedir una contrase√±a.
          # Usamos 'expect' para automatizar el primer inicio del vncserver si es necesario.
          # Creamos una contrase√±a simple (por ejemplo, 'password') solo para el inicio.
          echo -e "password\npassword\n" | vncserver

          echo "==========================================================="
          echo "‚úÖ CONEXI√ìN GR√ÅFICA LISTA (TigerVNC)"
          echo "Utiliza el siguiente link en tu cliente VNC (como RealVNC Viewer):"
          echo "Direcci√≥n VNC: ${{ env.TS_IP }}:5901"
          echo "Contrase√±a VNC: La que estableciste (o intenta 'password' si usaste el script de arriba)."
          echo "==========================================================="

      # 3. Instalaci√≥n de RustDesk
      - name: üì¶ Instalar RustDesk (Opcional)
        run: |
          echo "--- 3. Instalando RustDesk v√≠a Homebrew Cask ---"
          brew install --cask rustdesk
          echo "RustDesk instalado en /Applications/RustDesk.app"

      # 4. Mantener el flujo de trabajo activo
      - name: ‚è≥ Mantener el Runner Vivo para Acceso Remoto
        run: |
          echo "--- 4. Manteniendo la Sesi√≥n Abierta (M√°x 360 minutos) ---"
          sleep 21600
```eof

Con este cambio, el paso 2 deber√≠a instalar **TigerVNC** y luego iniciarlo para darte acceso al escritorio gr√°fico.
