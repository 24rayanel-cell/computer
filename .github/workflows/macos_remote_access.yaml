name: CRD-Ubuntu

on:
  # Permite ejecutar el flujo de trabajo manualmente desde la interfaz de GitHub
  workflow_dispatch:

jobs:
  crd-ubuntu:
    # Cambiamos el runner a la √∫ltima versi√≥n de Ubuntu
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      # --- Paso 1: Instalar Chrome Remote Desktop, XFCE4 y Dependencias ---
      - name: Instalar CRD Host y XFCE4 Desktop
        # Usamos Bash para la instalaci√≥n
        run: |
          echo "üîê Instalando Chrome Remote Desktop y dependencias..."
          
          # Actualizar e instalar dependencias b√°sicas
          sudo apt-get update -y
          sudo apt-get install -y wget curl x11-utils x11-xserver-utils
          
          # Descargar e instalar el paquete .deb de CRD
          CRD_DEB="chrome-remote-desktop_current_amd64.deb"
          wget -q -O $CRD_DEB https://dl.google.com/linux/direct/chrome-remote-desktop_current_amd64.deb
          sudo dpkg -i $CRD_DEB || sudo apt-get install -f -y # Instala y resuelve dependencias
          rm $CRD_DEB
          
          # Instalar XFCE4, un entorno de escritorio ligero, requerido por CRD
          echo "üñ•Ô∏è Instalando entorno de escritorio XFCE4..."
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y xfce4 xfce4-terminal xubuntu-core
          
          # Configurar CRD para que use XFCE4
          echo "exec /usr/sbin/startxfce4" | sudo tee /etc/chrome-remote-desktop-session
          
      # --- Paso 2: Configurar Tailscale ---
      - name: Configurar e Iniciar Tailscale
        run: |
          echo "üîë Configurando Tailscale..."
          
          # Instalaci√≥n de Tailscale usando el repositorio oficial de APT (para Debian/Ubuntu)
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.no-arch.gpg | sudo gpg --dearmor -o /usr/share/keyrings/tailscale-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu jammy main" | sudo tee /etc/apt/sources.list.d/tailscale.list

          # Instalar Tailscale
          sudo apt-get update
          sudo apt-get install -y tailscale
          
          # Iniciar Tailscale con la clave de autenticaci√≥n (Secret) y un nombre de host din√°mico
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-crd-$GITHUB_RUN_ID --accept-routes
          
          # Obtener la IP de Tailscale y guardarla en una variable de entorno de GitHub
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          
      # --- Paso 3: Registrar Chrome Remote Desktop Host ---
      - name: Registrar Chrome Remote Desktop Host
        run: |
          echo "üîë Registrando Chrome Remote Desktop host..."
          
          # WARNING: ESTE C√ìDIGO DE AUTORIZACI√ìN EXPIRA R√ÅPIDO.
          # Deber√≠as generar uno nuevo antes de usarlo. Lo mantengo aqu√≠
          # para igualar la estructura de tu archivo original.
          AUTH_CODE="4/0Ab32j9270BweUtIci8TVfoDd6wBYxQl6r2liMeK7nIEQFj_CCe5UB7Wupv54saDhNBfIgA"
          PIN="12345678"
          
          # Comando Linux para el registro, adaptado de tu ejemplo:
          # Usamos 'DISPLAY=' para ejecutar el programa sin un servidor X activo, ya que CRD gestiona el inicio de XFCE.
          DISPLAY= /opt/google/chrome-remote-desktop/start-host \
            --code="$AUTH_CODE" \
            --redirect-url="https://remotedesktop.google.com/_/oauthredirect" \
            --name="gh-crd-$(hostname)" \
            --pin="$PIN"
            
      # --- Paso 4: Mantener el CRD activo ---
      - name: Keep CRD Online
        run: |
          echo -e "\n=== Chrome Remote Desktop Active ==="
          echo "Tailscale IP: ${{ env.TAILSCALE_IP }}"
          echo "Con√©ctate a trav√©s de Chrome Remote Desktop web usando el PIN 12345678"
          echo "==============================\n"
          
          # Mantener el trabajo activo por la duraci√≥n restante (m√°x. 3600 minutos)
          # 'sleep infinity' mantendr√≠a el trabajo vivo hasta que se agote el tiempo de timeout
          sleep 3600
