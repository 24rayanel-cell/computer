name: Windows - Chrome Remote Desktop (CRD) - AutenticaciÃ³n por CÃ³digo

on:
  workflow_dispatch:

jobs:
  remote_session_crd:
    name: Iniciar SesiÃ³n Remota CRD (MÃ¡x 9999 minutos)
    runs-on: windows-latest
    timeout-minutes: 9999
    
    steps:
      - name: ðŸ’¾ Descargar e Instalar Chrome Remote Desktop Host
        # Descarga el instalador del host de CRD.
        run: |
          $InstallerURL = "https://dl.google.com/dl/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi"
          $OutputPath = "C:\Users\runneradmin\chromeremotedesktophost.msi"
          Write-Host "Descargando Chrome Remote Desktop Host..."
          
          # Descargar el instalador
          Invoke-WebRequest -Uri $InstallerURL -OutFile $OutputPath
          
          # InstalaciÃ³n silenciosa del MSI
          Write-Host "Instalando silenciosamente el Host de CRD..."
          Start-Process msiexec -ArgumentList "/i $OutputPath /qn" -Wait
          Write-Host "InstalaciÃ³n completada."

      - name: ðŸ”‘ Configurar y Ejecutar Servicio de CRD
        # Utiliza tu cÃ³digo de autenticaciÃ³n Ãºnico y la URL de redireccionamiento.
        env:
          CRD_AUTH_CODE: "4/0Ab32j91SMKCxGVyOT2gHvDoL7nXDuhVm-fj0eTuJXVyei7Z2-DmlNU8kxgfiZQJGjkpkqw"
          CRD_REDIRECT_URL: "https://remotedesktop.google.com/_/oauthredirect"
          CRD_HOST_NAME: "GitHub-Runner-Windows"
          CRD_PIN: "123456" # <- PIN que usarÃ¡s para conectarte, puedes cambiarlo

        run: |
          $CRD_PATH = "C:\Program Files\Google\Chrome Remote Desktop\remoting_host.exe"
          
          Write-Host "Configurando el Host de CRD con el cÃ³digo de autenticaciÃ³n..."

          # Comando de configuraciÃ³n y autorizaciÃ³n de Google:
          # Debe ejecutarse como SYSTEM o como administrador con los tokens.
          & $CRD_PATH --code="$env:CRD_AUTH_CODE" `
              --redirect-url="$env:CRD_REDIRECT_URL" `
              --host-name="$env:CRD_HOST_NAME" `
              --pin="$env:CRD_PIN" `
              --host-client-id="40693247926.apps.googleusercontent.com" `
              --host-secret="V0RjYjVwTEdmYlQzY3pBcU40b2Y5Q1g=" `
              --no-start

          Write-Host "Reiniciando el servicio para aplicar la configuraciÃ³n..."
          Start-Process -FilePath "C:\Program Files\Google\Chrome Remote Desktop\host_service_cli.exe" -ArgumentList "start" -Wait
          
          Write-Host "âœ… El Host de CRD se estÃ¡ ejecutando. Revisa https://remotedesktop.google.com/access"

      - name: â³ Mantener el Runner Vivo
        run: |
          Write-Host "Manteniendo el runner vivo por la duraciÃ³n mÃ¡xima..."
          # Puedes jugar en la sesiÃ³n remota hasta que se agote el tiempo de timeout-minutes (9999).
          Start-Sleep -Seconds 9999999
