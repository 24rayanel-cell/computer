name: RustDesk Host (macOS)

on:
  workflow_dispatch:

jobs:
  rustdesk:
    runs-on: macos-latest
    timeout-minutes: 360

    steps:
      - name: Install RustDesk
        run: |
          brew install --cask rustdesk

      - name: Prepare RustDesk environment
        run: |
          mkdir -p ~/rustdesk
          chmod 700 ~/rustdesk

      - name: Start RustDesk host and capture ID
        run: |
          PASSWORD=$(openssl rand -base64 12)
          echo "RUSTDESK_PASS=$PASSWORD" >> $GITHUB_ENV

          LOG_FILE=~/rustdesk/rustdesk.log
          mkdir -p $(dirname $LOG_FILE)
          touch $LOG_FILE

          # Arrancar RustDesk en segundo plano con relay pÃºblico
          nohup /Applications/RustDesk.app/Contents/MacOS/rustdesk \
            --password $PASSWORD \
            --serve-id hbbs-public.hh.ru \
            > $LOG_FILE 2>&1 &

          # Esperar unos segundos a que genere el ID
          sleep 10

          # Capturar el ID desde los logs
          RUSTDESK_ID=$(grep -oE 'Your RustDesk ID: [0-9 ]+' $LOG_FILE | head -n1 | awk -F': ' '{print $2}')
          echo "RUSTDESK_ID=$RUSTDESK_ID" >> $GITHUB_ENV

      - name: Show connection details
        run: |
          echo "==================== RUSTDESK ACCESS ===================="
          echo "ID: $RUSTDESK_ID"
          echo "Password: $RUSTDESK_PASS"
          echo "Connect using RustDesk client with the above credentials."
          echo "========================================================"

      - name: Keep runner alive
        run: |
          echo "Keeping RustDesk session active..."
          while true; do
            echo "[$(date)] RustDesk host active (ID: $RUSTDESK_ID)"
            sleep 300
          done
