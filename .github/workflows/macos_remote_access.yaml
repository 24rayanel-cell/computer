name: Windows - CRD y Tailscale (Acceso por Google)

on:
  workflow_dispatch:

jobs:
  remote_session_crd_ts:
    name: Iniciar Sesi√≥n Remota (M√°x 9999 minutos)
    runs-on: windows-latest
    timeout-minutes: 9999
    
    steps:
      
      - name: üöÄ 1. Instalaci√≥n y Autenticaci√≥n de Tailscale
        env:
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          Write-Host "--- 1. Tailscale Setup ---"
          
          # Descargar e instalar Tailscale
          $InstallerURL = "https://pkgs.tailscale.com/stable/tailscale-setup-latest.msi"
          Invoke-WebRequest -Uri $InstallerURL -OutFile "tailscale-setup.msi"
          Start-Process msiexec -ArgumentList "/i tailscale-setup.msi /qn" -Wait
          
          # Autenticaci√≥n de Tailscale
          $TailscalePath = "C:\Program Files\Tailscale\tailscale.exe"
          & $TailscalePath install-service
          & $TailscalePath up --authkey=$env:TAILSCALE_AUTHKEY --hostname="github-runner-crd" --accept-dns=false
          
          Write-Host "Tailscale instalado y autenticado."
          
      - name: üåê 2. Descargar e Instalar Chrome Remote Desktop Host
        run: |
          Write-Host "--- 2. Instalando CRD Host ---"
          $InstallerURL = "https://dl.google.com/dl/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi"
          $OutputPath = "C:\Users\runneradmin\chromeremotedesktophost.msi"
          
          Invoke-WebRequest -Uri $InstallerURL -OutFile $OutputPath
          
          # Instalaci√≥n silenciosa del MSI
          Write-Host "Instalando Host de CRD..."
          Start-Process msiexec -ArgumentList "/i $OutputPath /qn" -Wait
          Write-Host "Instalaci√≥n de CRD Host completada."

      - name: üîë 3. Configurar y Ejecutar Servicio de CRD (C√ìDIGO √öNICO)
        env:
          # üö® ¬°REEMPLAZA ESTE C√ìDIGO CON UNO NUEVO Y RECI√âN GENERADO!
          CRD_AUTH_CODE: "4/0Ab32j91SMKCxGVyOT2gHvDoL7nXDuhVm-fj0eTuJXVyei7Z2-DmlNU8kxgfiZQJGjkpkqw" 
          CRD_REDIRECT_URL: "https://remotedesktop.google.com/_/oauthredirect"
          CRD_HOST_NAME: "GitHub-Runner-CRD-TS"
          CRD_PIN: "123456" # PIN para acceder
          
        run: |
          Write-Host "--- 3. Configurando CRD con c√≥digo OAuth ---"

          # Usamos la ruta m√°s probable para el host en entornos de 64 bits que instalan MSIs:
          $CRD_HOST_PATH = "C:\Program Files (x86)\Google\Chrome Remote Desktop\remoting_host.exe"
          $CRD_CLI_PATH = "C:\Program Files (x86)\Google\Chrome Remote Desktop\host_service_cli.exe"
          
          # 1. Configurar el Host con el c√≥digo de autenticaci√≥n
          & $CRD_HOST_PATH --code="$env:CRD_AUTH_CODE" `
              --redirect-url="$env:CRD_REDIRECT_URL" `
              --host-name="$env:CRD_HOST_NAME" `
              --pin="$env:CRD_PIN" `
              --host-client-id="40693247926.apps.googleusercontent.com" `
              --host-secret="V0RjYjVwTEdmYlQzY3pBcU40b2Y5Q1g=" `
              --no-start

          # 2. Iniciar el servicio (usa la CLI para asegurar el inicio)
          Write-Host "Iniciando el servicio..."
          Start-Process -FilePath $CRD_CLI_PATH -ArgumentList "start" -Wait
          
          Write-Host "‚úÖ CRD Host configurado. Con√©ctate v√≠a web de Google. Tailscale est√° activo como backup."

      - name: ‚è≥ 4. Mantener el Runner Vivo
        run: |
          Write-Host "--- 4. Manteniendo la Sesi√≥n Abierta (M√°x 9999 minutos) ---"
          Start-Sleep -Seconds 9999999
