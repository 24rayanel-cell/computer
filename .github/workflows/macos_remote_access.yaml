name: CRD-Ubuntu

on:
  workflow_dispatch:

jobs:
  crd-ubuntu:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      # --- Paso 1: Instalar CRD Host y XFCE4 ---
      - name: 1. Instalar CRD Host y XFCE4 Desktop
        run: |
          echo "üîê Instalando Chrome Remote Desktop y entorno de escritorio..."
          
          # Actualizar e instalar dependencias b√°sicas
          sudo apt-get update -y
          sudo apt-get install -y wget curl x11-utils x11-xserver-utils
          
          # Descargar e instalar el paquete .deb de CRD
          CRD_DEB="chrome-remote-desktop_current_amd64.deb"
          wget -q -O $CRD_DEB https://dl.google.com/linux/direct/chrome-remote-desktop_current_amd64.deb
          sudo dpkg -i $CRD_DEB || sudo apt-get install -f -y 
          rm $CRD_DEB
          
          # Instalar XFCE4 y configurar CRD para usarlo
          echo "üñ•Ô∏è Instalando entorno de escritorio XFCE4..."
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y xfce4 xfce4-terminal xubuntu-core
          echo "exec /usr/sbin/startxfce4" | sudo tee /etc/chrome-remote-desktop-session
          
      # --- Paso 2: Configurar Tailscale ---
      - name: 2. Configurar e Iniciar Tailscale
        run: |
          echo "üîë Configurando Tailscale..."
          curl -fsSL https://tailscale.com/install.sh | sudo sh
          
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-crd-$GITHUB_RUN_ID --accept-routes
          
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          
      # --- Paso 3: Registrar Chrome Remote Desktop Host (¬°SOLUCI√ìN AL ERROR DE SESI√ìN!) ---
      - name: 3. Registrar CRD Host y Arrancar el Servicio de Usuario
        run: |
          echo "üîë Registrando Chrome Remote Desktop host..."
          
          # *** Asegurar que el c√≥digo de autorizaci√≥n es NUEVO ***
          # Si has estado probando esto por un tiempo, el c√≥digo anterior est√° CADUCADO.
          # ¬°Debes generar uno nuevo! Uso el que me diste por consistencia, pero revisa esto.
          AUTH_CODE="4/0Ab32j93Ih31JrMyhzbMTNTvUQaBtzGn_CZDa3x0HKT2MR3MiQXKcOPc0ZaKlxXu0kzg5DQ"
          PIN="12345678"
          RUNNER_USER=$(whoami)
          
          # 1. Ejecutar el comando de registro (crea la configuraci√≥n inicial)
          DISPLAY= /opt/google/chrome-remote-desktop/start-host \
            --code="$AUTH_CODE" \
            --redirect-url="https://remotedesktop.google.com/_/oauthredirect" \
            --name="gh-crd-$(hostname)" \
            --pin="$PIN"
            
          # 2. Habilitar 'linger' para que los servicios de usuario se mantengan activos sin sesi√≥n f√≠sica
          echo "üîß Habilitando el servicio 'linger' para el usuario $RUNNER_USER..."
          sudo loginctl enable-linger $RUNNER_USER
          
          # 3. Solucionar el error de permisos/sesi√≥n:
          # Es necesario asegurar que el servicio de CRD tenga permisos para iniciar el X server.
          # El archivo de CRD lo maneja systemd. Reiniciamos el daemon y activamos el servicio.
          echo "‚öôÔ∏è Reiniciando el servicio CRD..."
          # Usamos sudo con -E para preservar el entorno, esencial para systemctl --user
          sudo systemctl daemon-reload
          # Paramos si ya estaba corriendo (para aplicar el registro nuevo)
          /opt/google/chrome-remote-desktop/chrome-remote-desktop --stop
          # Arrancamos el servicio de CRD con el usuario actual
          sudo systemctl start chrome-remote-desktop@$RUNNER_USER.service
            
      # --- Paso 4: Mantener el CRD activo ---
      - name: 4. Monitorear y Mantener CRD Online
        run: |
          echo -e "\n=== Chrome Remote Desktop Activo === "
          echo "Tailscale IP: ${{ env.TAILSCALE_IP }}"
          echo "Con√©ctate a trav√©s de Chrome Remote Desktop web usando el PIN 12345678"
          echo "==============================\n"
          
          # Monitoreo del estado del servicio CRD cada 5 minutos
          while true; do
            echo "[$(date)] Servicio CRD activo (gestionado por systemd). Esperando timeout..."
            # Opcional: Mostrar el estado del servicio para depuraci√≥n si es necesario
            # systemctl status chrome-remote-desktop@$(whoami).service --user || true 
            sleep 300 
          done
